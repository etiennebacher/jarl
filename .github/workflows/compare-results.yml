name: Compare flir results

on:
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  TEST_REPO: etiennebacher/dplyr
  TEST_REPO_URL: https://github.com/etiennebacher/dplyr.git

jobs:
  compare-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr-branch

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Setup R to process lint results
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install R dependencies
        run: |
          R -e "install.packages(c('data.table', 'jsonlite', 'poorman'), repos = 'https://cloud.r-project.org')"

      - name: Clone test repository
        run: |
          git clone -b freeze-for-flir-CI ${{ env.TEST_REPO_URL }} test-repo --depth 1

      - name: Build flir from main branch
        run: |
          cd main-branch
          cargo build --release
          cp target/release/flir ../flir-main

      - name: Run flir on main branch
        run: |
          ./flir-main test-repo --output-format json > results_main.json
        continue-on-error: true

      - name: Build flir from PR branch
        run: |
          cd pr-branch
          cargo build --release
          cp target/release/flir ../flir-pr

      - name: Run flir on PR branch
        run: |
          ./flir-pr test-repo --output-format json > results_pr.json
        continue-on-error: true

      - name: Upload main branch results
        uses: actions/upload-artifact@v4
        with:
          name: results-main
          path: results_main.json

      - name: Upload PR branch results
        uses: actions/upload-artifact@v4
        with:
          name: results-pr
          path: results_pr.json

      - name: Process lint results
        run: |
          source(".github/scripts/process_lint_ci.R", echo = TRUE)
        shell: Rscript {0}

      - name: Upload results
        id: artifact-upload-step
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: .github/scripts/

      - name: Push generated plot as a GH-bot comment
        run: |
          # Comment contents:
          echo -e "\nGenerated via commit ${{ github.event.pull_request.head.sha }}" >> report.md
          echo -e "\nDownload link for the artifact containing the test results: [â†“ lint-results.zip](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.artifact-upload-step.outputs.artifact-id }})" >> lint_comparison.md
          cml comment update lint_comparison.md.md
        shell: bash
