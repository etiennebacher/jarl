name: Ecosystem check

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  TEST_REPOS: |
    tidyverse/dplyr@384ff2c4af79a9bd9142d8bdab23efbcd52f275b # 2025-07-25
    tidyverse/ggplot2@bed8e32d45c7dc98afb783b409edac98854d41a7 # 2025-07-21

jobs:
  compare-results:
    runs-on: macos-latest

    steps:
      - name: Checkout current PR branch
        uses: actions/checkout@v4

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Build flir binary from PR
        run: cargo build --release
        working-directory: ./

      - name: Save PR binary path
        run: echo "PR_FLIR=$(pwd)/target/release/flir" >> $GITHUB_ENV

      - name: Build flir binary from main branch
        run: |
          git fetch origin main
          git checkout origin/main
          cargo build --release
        working-directory: ./

      - name: Save main binary path
        run: echo "MAIN_FLIR=$(pwd)/target/release/flir" >> $GITHUB_ENV

      - name: Clone all test repos
        run: |
          mkdir -p test-repos
          cd test-repos
          for repo in $TEST_REPOS; do
            commit_sha=$(echo "$repo" | cut -d'@' -f2)
            git clone --revision=$commit_sha --depth 1 https://github.com/$repo.git $(echo $repo | tr '/' '_')
          done

      - name: Run CLI on all repos
        run: |
          mkdir -p results
          cd test-repos
          for repo in $TEST_REPOS; do
            repo_dir=$(echo $repo | tr '/' '_')
            echo "Running flir on $repo_dir"

            # Run main
            $MAIN_FLIR "$repo_dir" --output-format json > "../results/${repo_dir}_main.json" || true

            # Run PR
            $PR_FLIR "$repo_dir" --output-format json > "../results/${repo_dir}_pr.json" || true
          done

      - name: Upload all result JSONs
        uses: actions/upload-artifact@v4
        with:
          name: flir-json-results
          path: results/

      - name: Foo
        run: |
          ls

      - name: Foo2
        run: |
          ls results

      - name: Setup R to process lint results
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install R dependencies
        run: |
          R -e "install.packages(c('data.table', 'jsonlite', 'poorman'))"

      - name: Process lint results
        run: |
          source(".github/scripts/process_lint_ci.R", echo = TRUE)
        shell: Rscript {0}

      - name: Upload results
        id: artifact-upload-step
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: .github/scripts/

      - name: Post comment on PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: lint_comparison.md
          comment-tag: execution
